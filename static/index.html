<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nagla Store</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 25px;
        }
        
        .nav-links a:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }
        
        .auth-section {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .cart-icon {
            position: relative;
            cursor: pointer;
            font-size: 1.5rem;
            color: #667eea;
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        main {
            padding: 2rem 0;
        }
        
        .page {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .page.active {
            display: block;
        }
        
        .hero {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 20px;
            margin-bottom: 2rem;
        }
        
        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .product-image {
            width: 100%;
            height: 250px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            overflow: hidden;
            position: relative; /* For status badge */
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4757;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .product-status.in-stock {
            background: #2ed573;
        }
        
        .filter-section {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .filter-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
        
        .product-info {
            padding: 1.5rem;
        }
        
        .product-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .product-description {
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .product-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .product-price .original-price {
            font-size: 1rem;
            color: #999;
            text-decoration: line-through;
            margin-left: 10px;
        }
        
        .add-to-cart {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .add-to-cart:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .cart-item .item-details {
            flex-grow: 1;
        }

        .cart-item .item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-total {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 2rem 0;
            color: #667eea;
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .user-info {
            display: none;
            align-items: center;
            gap: 1rem;
        }

        /* Product Detail Page Styles */
        .product-detail-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .product-detail-images {
            flex: 1;
            min-width: 300px;
        }

        .product-detail-main-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 1rem;
        }

        .product-detail-thumbnails {
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }

        .product-detail-thumbnails img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }

        .product-detail-thumbnails img.active {
            border-color: #667eea;
        }

        .product-detail-info {
            flex: 2;
            min-width: 300px;
        }

        .product-detail-info h2 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .product-detail-info .price {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .product-detail-info .price .discount {
            color: #ff4757;
            margin-right: 10px;
        }

        .product-detail-info .price .original {
            text-decoration: line-through;
            color: #999;
            font-size: 1.2rem;
        }

        .product-detail-info p {
            margin-bottom: 1rem;
            color: #555;
        }

        .product-options {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .product-options div {
            flex: 1;
            min-width: 150px;
        }

        .product-options label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .product-options select,
        .product-options input[type="number"] {
            width: 100%;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-control button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .quantity-control input {
            width: 60px;
            text-align: center;
            -moz-appearance: textfield; /* Firefox */
        }

        .quantity-control input::-webkit-outer-spin-button,
        .quantity-control input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .reviews-section {
            margin-top: 3rem;
            border-top: 1px solid #eee;
            padding-top: 2rem;
        }

        .review-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .review-card strong {
            color: #667eea;
        }

        .review-card .rating {
            color: gold;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }

            .product-detail-card {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">🧵 Nagla Store</div>
            <ul class="nav-links">
                <li><a href="#" onclick="showPage('home')">الرئيسية</a></li>
                <li><a href="#" onclick="showPage('products')">المنتجات</a></li>
                <li><a href="#" onclick="showPage('orders')">طلباتي</a></li>
                <li><a href="#" onclick="showPage('about')">من نحن</a></li>
                <li><a href="#" onclick="showPage('contact')">تواصل معنا</a></li>
            </ul>
            <div class="auth-section">
                <div class="cart-icon" onclick="showPage('cart')">
                    🛒
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <div id="authButtons">
                    <button class="btn btn-secondary" onclick="showPage('login')">تسجيل دخول</button>
                </div>
                <div id="userInfo" class="user-info">
                    <span id="userName"></span>
                    <button class="btn btn-secondary" onclick="logout()">خروج</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="container">
        <!-- الصفحة الرئيسية -->
        <div id="home" class="page active">
            <div class="hero">
                <h1>مرحباً بكم في معرض Nagla Store</h1>
                <p>أجمل التصاميم وأفضل الخامات لجميع المناسبات</p>
                <button class="btn btn-primary" onclick="showPage('products')">تصفح المنتجات</button>
            </div>
            
            <h2 style="text-align: center; margin: 2rem 0; color: #667eea;">أحدث المنتجات</h2>
            <div class="products-grid" id="featuredProducts"></div>
        </div>

        <!-- صفحة المنتجات -->
        <div id="products" class="page">
            <h2 style="text-align: center; margin-bottom: 2rem; color: #667eea;">جميع المنتجات</h2>
            
            <div class="filter-section">
                <h3 style="color: #667eea; margin-bottom: 1rem;">تصفية المنتجات حسب الفئة:</h3>
                <div class="filter-buttons" id="categoryFilterButtons">
                    <button class="filter-btn active" onclick="filterProducts(null, this)">جميع المنتجات</button>
                </div>
                <input type="text" id="productSearch" onkeyup="searchProducts()" placeholder="ابحث عن منتج..." style="width: 50%; margin-top: 1rem; padding: 0.8rem; border-radius: 10px; border: 1px solid #ccc;">
            </div>
            
            <div class="products-grid" id="allProducts"></div>
        </div>

        <!-- صفحة تفاصيل المنتج -->
        <div id="productDetail" class="page">
            <button class="btn btn-secondary" onclick="showPage('products')" style="margin-bottom: 1rem;">&lt; العودة للمنتجات</button>
            <div id="productDetailContent">
                <!-- Product details will be loaded here -->
            </div>
        </div>

        <!-- صفحة من نحن -->
        <div id="about" class="page">
            <h2 style="color: #667eea; margin-bottom: 2rem;">من نحن</h2>
            <div style="line-height: 2; font-size: 1.1rem;">
                <p style="margin-bottom: 1.5rem;">
                    Nagla Store - رحلة إبداع وتميز في عالم الأزياء والخياطة منذ أكثر من 15 عاماً.
                </p>
                <p style="margin-bottom: 1.5rem;">
                    نحن نفخر بتقديم أجود أنواع الملابس المفصلة حسب الطلب، من الفساتين الراقية إلى الملابس التراثية الأصيلة، 
                    باستخدام أفضل الخامات والتقنيات الحديثة في الخياطة.
                </p>
                <p style="margin-bottom: 1.5rem;">
                    رؤيتنا هي أن نكون الخيار الأول لكل من يبحث عن التميز والأناقة في الملبس، 
                    ونسعى دائماً لتحقيق رضا عملائنا من خلال الجودة العالية والخدمة المتميزة.
                </p>
                <h3 style="color: #667eea; margin: 2rem 0 1rem;">خدماتنا تشمل:</h3>
                <ul style="list-style: none; padding-right: 2rem;">
                    <li style="margin-bottom: 0.5rem;">✨ تفصيل الفساتين للمناسبات الخاصة</li>
                    <li style="margin-bottom: 0.5rem;">✨ الملابس التراثية والشعبية</li>
                    <li style="margin-bottom: 0.5rem;">✨ ملابس الأطفال المميزة</li>
                    <li style="margin-bottom: 0.5rem;">✨ تعديل وإصلاح الملابس</li>
                    <li style="margin-bottom: 0.5rem;">✨ استشارات الأزياء والتصميم</li>
                </ul>
            </div>
        </div>

        <!-- صفحة التواصل -->
        <div id="contact" class="page">
            <h2 style="color: #667eea; margin-bottom: 2rem;">تواصل معنا</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <form id="contactForm" onsubmit="submitContactMessage(event)">
                        <div class="form-group">
                            <label for="contactName">الاسم:</label>
                            <input type="text" id="contactName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="contactPhone">رقم الهاتف:</label>
                            <input type="tel" id="contactPhone" name="phone" required>
                        </div>
                        <div class="form-group">
                            <label for="contactEmail">البريد الإلكتروني:</label>
                            <input type="email" id="contactEmail" name="email">
                        </div>
                        <div class="form-group">
                            <label for="contactSubject">الموضوع (اختياري):</label>
                            <input type="text" id="contactSubject" name="subject">
                        </div>
                        <div class="form-group">
                            <label for="contactMessage">الرسالة:</label>
                            <textarea id="contactMessage" name="message" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">إرسال الرسالة</button>
                    </form>
                </div>
                <div>
                    <h3 style="color: #667eea; margin-bottom: 1rem;">معلومات التواصل</h3>
                    <div style="line-height: 2.5;">
                        <p><strong>📱 الهاتف:</strong> +20 123 456 7890</p>
                        <p><strong>📧 البريد الإلكتروني:</strong> info@ummohamed.com</p>
                        <p><strong>📍 العنوان:</strong> القاهرة، مصر</p>
                        <p><strong>🕒 ساعات العمل:</strong> السبت - الخميس: 9 ص - 8 م</p>
                    </div>
                    <div style="margin-top: 2rem;">
                        <h4 style="color: #667eea; margin-bottom: 1rem;">تابعونا على:</h4>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-secondary">فيسبوك</button>
                            <button class="btn btn-secondary">إنستغرام</button>
                            <button class="btn btn-secondary">واتساب</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحة تسجيل الدخول -->
        <div id="login" class="page">
            <div class="login-form">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 2rem;">تسجيل الدخول</h2>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">البريد الإلكتروني:</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">كلمة المرور:</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">دخول</button>
                </form>
                <p style="text-align: center; margin-top: 1rem;">
                    ليس لديك حساب؟ <a href="#" onclick="showRegister()" style="color: #667eea;">إنشاء حساب جديد</a>
                </p>
                
                <div id="registerForm" style="display: none; margin-top: 2rem;">
                    <h3 style="text-align: center; color: #667eea; margin-bottom: 1rem;">إنشاء حساب جديد</h3>
                    <form onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <label for="registerName">الاسم الكامل:</label>
                            <input type="text" id="registerName" required>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">البريد الإلكتروني:</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPhone">رقم الهاتف:</label>
                            <input type="tel" id="registerPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">كلمة المرور:</label>
                            <input type="password" id="registerPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">إنشاء الحساب</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- صفحة السلة -->
        <div id="cart" class="page">
            <h2 style="color: #667eea; margin-bottom: 2rem;">سلة التسوق</h2>
            <div id="cartItems"></div>
            <div class="cart-total" id="cartTotal">المجموع: 0 جنيه</div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="showCheckoutPage()">إتمام الطلب</button>
                <button class="btn btn-secondary" onclick="clearCart()" style="margin-right: 1rem;">إفراغ السلة</button>
            </div>
        </div>

        <!-- صفحة إتمام الطلب -->
        <div id="checkout" class="page">
            <h2 style="color: #667eea; margin-bottom: 2rem;">إتمام الطلب</h2>
            <form id="checkoutForm" onsubmit="handleCheckout(event)">
                <div class="form-group">
                    <label for="checkoutName">الاسم الكامل:</label>
                    <input type="text" id="checkoutName" required>
                </div>
                <div class="form-group">
                    <label for="checkoutPhone">رقم الهاتف:</label>
                    <input type="tel" id="checkoutPhone" required>
                </div>
                <div class="form-group">
                    <label for="checkoutAddress">عنوان التسليم:</label>
                    <textarea id="checkoutAddress" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="paymentMethod">طريقة الدفع:</label>
                    <select id="paymentMethod">
                        <option value="Cash on Delivery">الدفع عند الاستلام</option>
                        <!-- <option value="Credit Card">بطاقة ائتمان</option> -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderNotes">ملاحظات إضافية (اختياري):</label>
                    <textarea id="orderNotes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">تأكيد الطلب</button>
            </form>
        </div>

        <!-- صفحة طلباتي -->
        <div id="orders" class="page">
            <h2 style="color: #667eea; margin-bottom: 2rem;">طلباتي السابقة</h2>
            <div id="userOrders">
                <p style="text-align: center; color: #666; padding: 2rem;">لا توجد طلبات سابقة حتى الآن.</p>
            </div>
        </div>
    </main>

    <script>
        // لم يعد API_BASE_URL مطلوبًا بهذا الشكل لأن الواجهة الأمامية والخلفية على نفس الأصل
        // لكننا سنحتفظ بها لسهولة التمييز بين طلبات الـ API وخدمة الملفات الثابتة.
        const API_BASE_URL = 'http://127.0.0.1:5000/api'; 

        let products = [];
        let categories = [];
        let currentProductDetail = null; // To store the product being viewed in detail

        let currentUser = null; // This will hold user data after login

        // وظيفة عامة لإرسال طلبات fetch مع تضمين الكوكيز
        // هذا ضروري لضمان أن جلسة المستخدم (user_id) يتم إرسالها إلى الخادم
        async function fetchWithCredentials(url, options = {}) {
            options.credentials = 'include';
            // التأكد من أن Headers موجودة وإضافة Content-Type إذا لم تكن موجودة لطلبات POST/PUT
            if (options.method === 'POST' || options.method === 'PUT') {
                options.headers = {
                    ...options.headers,
                    'Content-Type': 'application/json',
                };
            }
            return fetch(url, options);
        }

        // Utility to fetch current user data from session (if logged in)
        async function fetchCurrentUser() {
            try {
                // استخدام fetchWithCredentials لضمان إرسال الكوكيز لجلسة المستخدم
                const response = await fetchWithCredentials(`${API_BASE_URL}/user`);
                const data = await response.json();
                if (response.ok && data.user) {
                    currentUser = data.user;
                } else {
                    currentUser = null;
                }
                updateAuthUI();
                await fetchCart(); // Fetch cart on user status change
            } catch (error) {
                console.error('Error fetching current user:', error);
                currentUser = null;
                updateAuthUI();
                showNotification('تعذر التحقق من حالة تسجيل الدخول. يرجى المحاولة مرة أخرى.', 'error');
            }
        }

        // عرض الصفحات
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            // Specific actions for pages
            if (pageId === 'cart') {
                fetchCart();
            } else if (pageId === 'orders') {
                fetchUserOrders();
            } else if (pageId === 'login') {
                document.getElementById('registerForm').style.display = 'none'; // Hide register form by default
            }
        }

        // تحميل الفئات من الخادم
        async function fetchCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`); // لا تحتاج لـ credentials لأنها بيانات عامة
                categories = await response.json();
                renderCategoryFilterButtons();
            } catch (error) {
                console.error('خطأ في تحميل الفئات:', error);
                showNotification('فشل تحميل الفئات.', 'error');
            }
        }

        // عرض أزرار تصفية الفئات
        function renderCategoryFilterButtons() {
            const container = document.getElementById('categoryFilterButtons');
            if (!container) return; // Exit if container not found

            container.innerHTML = '<button class="filter-btn active" onclick="filterProducts(null, this)">جميع المنتجات</button>';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.classList.add('filter-btn');
                button.textContent = category.name;
                button.onclick = () => filterProducts(category.id, button);
                container.appendChild(button);
            });
        }

        // تحميل المنتجات من الخادم
        async function fetchProducts(categoryId = null, searchTerm = '') {
            let url = `${API_BASE_URL}/products`;
            const params = new URLSearchParams();
            if (categoryId) {
                params.append('category_id', categoryId);
            }
            if (searchTerm) {
                params.append('search', searchTerm);
            }
            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            try {
                const response = await fetch(url); // لا تحتاج لـ credentials لأنها بيانات عامة
                products = await response.json();
                loadProductsIntoGrids();
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                showNotification('فشل تحميل المنتجات. يرجى المحاولة لاحقًا.', 'error');
            }
        }

        // عرض المنتجات في الشبكات (الرئيسية وكل المنتجات)
        function loadProductsIntoGrids() {
            const featuredContainer = document.getElementById('featuredProducts');
            const allContainer = document.getElementById('allProducts');

            const productCardHTML = (product) => `
                <div class="product-card" onclick="showProductDetail(${product.id})">
                    <div class="product-status ${product.in_stock ? 'in-stock' : ''}">${product.in_stock ? 'متوفر' : 'غير متوفر'}</div>
                    <div class="product-image">
                        ${product.image.startsWith('http') ? 
                            `<img src="${product.image}" alt="${product.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='🎽';">` : 
                            product.image
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-title">${product.name}</div>
                        <div class="product-description">${product.description.substring(0, 70)}...</div>
                        <div class="product-price">
                            ${product.has_discount ? `<span class="discount">${product.final_price} جنيه</span> <span class="original-price">${product.price} جنيه</span>` : `${product.price} جنيه`}
                        </div>
                        <button class="add-to-cart" onclick="event.stopPropagation(); showProductDetail(${product.id})" ${!product.in_stock ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                            ${product.in_stock ? 'عرض التفاصيل وإضافة للسلة' : 'غير متوفر'}
                        </button>
                    </div>
                </div>
            `;
            
            if (featuredContainer) {
                // Display only featured products
                const featuredProducts = products.filter(p => p.is_featured);
                featuredContainer.innerHTML = featuredProducts.slice(0, 4).map(productCardHTML).join('');
            }
            if (allContainer) {
                allContainer.innerHTML = products.map(productCardHTML).join('');
            }
        }

        // تصفية المنتجات
        function filterProducts(categoryId, buttonElement) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            fetchProducts(categoryId); // Fetch products based on category ID
        }

        // البحث عن المنتجات
        let searchTimeout;
        function searchProducts() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchQuery = document.getElementById('productSearch').value.trim();
                fetchProducts(null, searchQuery); // Fetch products with search query
            }, 300);
        }

        // عرض تفاصيل المنتج
        async function showProductDetail(productId) {
            showPage('productDetail');
            const productDetailContent = document.getElementById('productDetailContent');
            productDetailContent.innerHTML = '<p style="text-align: center;">جاري تحميل تفاصيل المنتج...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`); // لا تحتاج لـ credentials لأنها بيانات عامة
                if (!response.ok) {
                    throw new Error('Product not found');
                }
                const product = await response.json();
                currentProductDetail = product; // Store the current product for adding to cart
                
                let sizesOptions = product.sizes.map(s => `<option value="${s}">${s}</option>`).join('');
                let colorsOptions = product.colors.map(c => `<option value="${c}">${c}</option>`).join('');

                let reviewsHTML = '';
                if (product.reviews && product.reviews.length > 0) {
                    reviewsHTML = `
                        <h3>تقييمات العملاء (${product.reviews.length}) - متوسط التقييم: ${product.average_rating.toFixed(1)}/5</h3>
                        ${product.reviews.map(review => `
                            <div class="review-card">
                                <strong>${review.user_name}</strong> - <span class="rating">${'⭐'.repeat(review.rating)}</span>
                                <p><strong>${review.title || ''}</strong></p>
                                <p>${review.comment}</p>
                                <small>${new Date(review.created_at).toLocaleDateString('ar-EG')}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    reviewsHTML = '<p>لا توجد تقييمات لهذا المنتج بعد.</p>';
                }


                productDetailContent.innerHTML = `
                    <div class="product-detail-card">
                        <div class="product-detail-images">
                            <img src="${product.image}" alt="${product.name}" class="product-detail-main-image" id="mainProductImage">
                            <div class="product-detail-thumbnails">
                                <img src="${product.image}" alt="${product.name}" class="active" onclick="changeMainImage(this)">
                                ${product.additional_images.map(img => `
                                    <img src="${img}" alt="${product.name}" onclick="changeMainImage(this)">
                                `).join('')}
                            </div>
                        </div>
                        <div class="product-detail-info">
                            <h2>${product.name}</h2>
                            <div class="price">
                                ${product.has_discount ? `<span class="discount">${product.final_price} جنيه</span> <span class="original">${product.price} جنيه</span>` : `${product.price} جنيه`}
                            </div>
                            <p><strong>الوصف:</strong> ${product.description}</p>
                            <p><strong>التصنيف:</strong> ${product.category}</p>
                            <p><strong>الخامة:</strong> ${product.material || 'غير محدد'}</p>
                            <p><strong>مدة التسليم:</strong> ${product.delivery_time || 'غير محدد'}</p>
                            <p><strong>تعليمات العناية:</strong> ${product.care_instructions || 'غير محدد'}</p>
                            <p><strong>عدد المشاهدات:</strong> ${product.views_count}</p>
                            <p class="product-status ${product.in_stock ? 'in-stock' : ''}">${product.in_stock ? 'متوفر' : 'غير متوفر'} - الكمية المتاحة: ${product.stock_quantity}</p>

                            <div class="product-options">
                                <div class="form-group" style="${product.sizes.length === 0 ? 'display:none;' : ''}">
                                    <label for="productSize">المقاس:</label>
                                    <select id="productSize">${sizesOptions}</select>
                                </div>
                                <div class="form-group" style="${product.colors.length === 0 ? 'display:none;' : ''}">
                                    <label for="productColor">اللون:</label>
                                    <select id="productColor">${colorsOptions}</select>
                                </div>
                                <div class="form-group">
                                    <label for="productQuantity">الكمية:</label>
                                    <div class="quantity-control">
                                        <button onclick="changeQuantity(-1)">-</button>
                                        <input type="number" id="productQuantity" value="1" min="1" max="${product.stock_quantity}" onchange="validateQuantity()">
                                        <button onclick="changeQuantity(1)">+</button>
                                    </div>
                                </div>
                                <div class="form-group" style="width: 100%;">
                                    <label for="productNotes">ملاحظات خاصة (اختياري):</label>
                                    <textarea id="productNotes" rows="2"></textarea>
                                </div>
                            </div>
                            <button class="btn btn-primary add-to-cart" style="width: 100%; margin-top: 1rem;" 
                                onclick="addToCartFromDetail()" ${!product.in_stock ? 'disabled' : ''}>
                                ${product.in_stock ? 'إضافة إلى السلة' : 'غير متوفر حالياً'}
                            </button>
                        </div>
                    </div>
                    <div class="reviews-section">
                        ${reviewsHTML}
                    </div>
                `;
            } catch (error) {
                console.error('خطأ في تحميل تفاصيل المنتج:', error);
                productDetailContent.innerHTML = '<p style="text-align: center; color: red;">عذراً، لا يمكن تحميل تفاصيل المنتج.</p>';
            }
        }

        function changeMainImage(thumbnail) {
            document.querySelectorAll('.product-detail-thumbnails img').forEach(img => img.classList.remove('active'));
            thumbnail.classList.add('active');
            document.getElementById('mainProductImage').src = thumbnail.src;
        }

        function changeQuantity(delta) {
            const quantityInput = document.getElementById('productQuantity');
            let currentQuantity = parseInt(quantityInput.value);
            let newQuantity = currentQuantity + delta;
            
            if (newQuantity < 1) newQuantity = 1;
            if (newQuantity > currentProductDetail.stock_quantity) newQuantity = currentProductDetail.stock_quantity;
            
            quantityInput.value = newQuantity;
        }

        function validateQuantity() {
            const quantityInput = document.getElementById('productQuantity');
            let currentQuantity = parseInt(quantityInput.value);
            
            if (isNaN(currentQuantity) || currentQuantity < 1) {
                quantityInput.value = 1;
            } else if (currentQuantity > currentProductDetail.stock_quantity) {
                quantityInput.value = currentProductDetail.stock_quantity;
            }
        }

        // إضافة للسلة من صفحة التفاصيل
        async function addToCartFromDetail() {
            if (!currentUser) {
                showNotification('يرجى تسجيل الدخول أولاً لإضافة منتجات إلى السلة', 'error');
                showPage('login');
                return;
            }

            if (!currentProductDetail) {
                showNotification('خطأ: لا يوجد منتج محدد لإضافته للسلة', 'error');
                return;
            }

            const productId = currentProductDetail.id;
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const selectedSize = document.getElementById('productSize') ? document.getElementById('productSize').value : null;
            const selectedColor = document.getElementById('productColor') ? document.getElementById('productColor').value : null;
            const notes = document.getElementById('productNotes') ? document.getElementById('productNotes').value : '';

            if (currentProductDetail.stock_quantity < quantity) {
                showNotification('الكمية المطلوبة غير متوفرة حالياً', 'error');
                return;
            }

            try {
                // استخدام fetchWithCredentials لضمان إرسال الكوكيز
                const response = await fetchWithCredentials(`${API_BASE_URL}/cart/add`, {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: quantity,
                        selected_size: selectedSize,
                        selected_color: selectedColor,
                        notes: notes
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message, 'success');
                    updateCartCount(data.cart.count);
                } else {
                    showNotification(data.error || 'فشل إضافة المنتج إلى السلة', 'error');
                }
            } catch (error) {
                console.error('خطأ في إضافة المنتج إلى السلة:', error);
                showNotification('تعذر الاتصال بالخادم لإضافة المنتج إلى السلة', 'error');
            }
        }
        
        // عرض الإشعارات
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 2rem;
                background: ${type === 'success' ? '#2ed573' : type === 'error' ? '#ff4757' : '#667eea'};
                color: white;
                border-radius: 10px;
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // تحديث عدد عناصر السلة في الواجهة العلوية
        function updateCartCount(count) {
            document.getElementById('cartCount').textContent = count;
        }

        // جلب سلة التسوق من الخادم
        async function fetchCart() {
            try {
                // استخدام fetchWithCredentials لضمان إرسال الكوكيز
                const response = await fetchWithCredentials(`${API_BASE_URL}/cart`);
                const data = await response.json();
                if (response.ok) {
                    updateCartUI(data.items, data.total, data.count);
                } else {
                     // If server returns error (e.g., 401 Not Authenticated), treat as empty cart
                    console.error('Error fetching cart:', data.error);
                    updateCartUI([], 0, 0); 
                }
            } catch (error) {
                console.error('خطأ في تحميل السلة:', error);
                showNotification('فشل تحميل السلة.', 'error');
                updateCartUI([], 0, 0); // Show empty cart on error
            }
        }

        // تحديث واجهة السلة
        function updateCartUI(cartItems, total, count) {
            const cartItemsContainer = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            updateCartCount(count);

            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">السلة فارغة</p>';
            } else {
                cartItemsContainer.innerHTML = cartItems.map(item => `
                    <div class="cart-item" data-item-id="${item.id}">
                        <div class="item-details">
                            <strong>${item.product.name}</strong><br>
                            <small>الكمية: ${item.quantity}</small>
                            ${item.selected_size ? `<small> | المقاس: ${item.selected_size}</small>` : ''}
                            ${item.selected_color ? `<small> | اللون: ${item.selected_color}</small>` : ''}
                            ${item.notes ? `<small> | ملاحظات: ${item.notes}</small>` : ''}
                        </div>
                        <div class="item-controls">
                            <input type="number" value="${item.quantity}" min="1" 
                                onchange="updateCartItemQuantity(${item.id}, this.value)" 
                                style="width: 60px; text-align: center; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc;">
                            <div style="font-weight: bold; color: #667eea;">${item.total_price} جنيه</div>
                            <button onclick="removeFromCart(${item.id})" style="color: #ff4757; background: none; border: none; cursor: pointer; font-size: 1.2rem;">✖</button>
                        </div>
                    </div>
                `).join('');
            }
            
            cartTotal.textContent = `المجموع: ${total} جنيه`;
        }

        // تحديث كمية عنصر في السلة
        async function updateCartItemQuantity(itemId, newQuantity) {
            newQuantity = parseInt(newQuantity);
            if (isNaN(newQuantity) || newQuantity < 1) {
                showNotification('الكمية يجب أن تكون رقماً صحيحاً وموجباً.', 'error');
                fetchCart(); // Re-fetch to revert changes
                return;
            }

            try {
                // استخدام fetchWithCredentials لضمان إرسال الكوكيز
                const response = await fetchWithCredentials(`${API_BASE_URL}/cart/update/${itemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ quantity: newQuantity })
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message, 'success');
                    updateCartUI(data.cart.items, data.cart.total, data.cart.count);
                } else {
                    showNotification(data.error || 'فشل تحديث كمية المنتج في السلة', 'error');
                    fetchCart(); // Re-fetch to revert changes on error
                }
            } catch (error) {
                console.error('خطأ في تحديث السلة:', error);
                showNotification('تعذر الاتصال بالخادم لتحديث السلة', 'error');
                fetchCart(); // Re-fetch to revert changes on network error
            }
        }

        // حذف من السلة
        async function removeFromCart(itemId) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج من السلة؟')) {
                return;
            }
            try {
                // استخدام fetchWithCredentials لضمان إرسال الكوكيز
                const response = await fetchWithCredentials(`${API_BASE_URL}/cart/remove/${itemId}`, {
                    method: 'DELETE',
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message, 'success');
                    updateCartUI(data.cart.items, data.cart.total, data.cart.count);
                } else {
                    showNotification(data.error || 'فشل حذف المنتج من السلة', 'error');
                }
            } catch (error) {
                console.error('خطأ في حذف المنتج من السلة:', error);
                showNotification('تعذر الاتصال بالخادم لحذف المنتج', 'error');
            }
        }

        // إفراغ السلة
        async function clearCart() {
            if (confirm('هل أنت متأكد من إفراغ السلة بالكامل؟')) {
                try {
                    // استخدام fetchWithCredentials لضمان إرسال الكوكيز
                    const response = await fetchWithCredentials(`${API_BASE_URL}/cart/clear`, {
                        method: 'POST',
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showNotification(data.message, 'success');
                        updateCartUI(data.cart.items, data.cart.total, data.cart.count);
                    } else {
                        showNotification(data.error || 'فشل إفراغ السلة', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في إفراغ السلة:', error);
                    showNotification('تعذر الاتصال بالخادم لإفراغ السلة', 'error');
                }
            }
        }

        // الانتقال لصفحة إتمام الطلب
        async function showCheckoutPage() {
            if (!currentUser) {
                showNotification('يرجى تسجيل الدخول أولاً لإتمام الطلب', 'error');
                showPage('login');
                return;
            }
            // استخدام fetchWithCredentials لجلب السلة
            const cartResponse = await fetchWithCredentials(`${API_BASE_URL}/cart`);
            const cartData = await cartResponse.json();

            if (cartData.items.length === 0) {
                showNotification('سلة التسوق فارغة لا يمكن إتمام الطلب', 'error');
                return;
            }

            // Pre-fill checkout form with user info if available
            document.getElementById('checkoutName').value = currentUser.name || '';
            document.getElementById('checkoutPhone').value = currentUser.phone || '';
            document.getElementById('checkoutAddress').value = currentUser.address || '';

            showPage('checkout');
        }

        // إتمام الطلب (Checkout)
        async function handleCheckout(event) {
            event.preventDefault();

            const customerName = document.getElementById('checkoutName').value;
            const customerPhone = document.getElementById('checkoutPhone').value;
            const customerAddress = document.getElementById('checkoutAddress').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('orderNotes').value;

            try {
                // استخدام fetchWithCredentials لإتمام الطلب
                const response = await fetchWithCredentials(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_phone: customerPhone,
                        customer_address: customerAddress,
                        payment_method: paymentMethod,
                        notes: notes
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message + ` رقم طلبك هو: ${data.order.order_number}`, 'success');
                    updateCartCount(0); // Clear cart count on successful order
                    showPage('home'); // Go to home after order
                } else {
                    showNotification(data.error || 'فشل إتمام الطلب', 'error');
                }
            } catch (error) {
                console.error('خطأ في إتمام الطلب:', error);
                showNotification('تعذر الاتصال بالخادم لإتمام الطلب', 'error');
            }
        }

        // جلب وعرض طلبات المستخدم
        async function fetchUserOrders() {
            const userOrdersContainer = document.getElementById('userOrders');
            if (!currentUser) {
                userOrdersContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">يرجى تسجيل الدخول لعرض طلباتك.</p>';
                return;
            }

            try {
                // استخدام fetchWithCredentials لجلب طلبات المستخدم
                const response = await fetchWithCredentials(`${API_BASE_URL}/orders`);
                const data = await response.json();
                if (response.ok && data.length > 0) {
                    userOrdersContainer.innerHTML = data.map(order => `
                        <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; background: #fdfdfd; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <p><strong>رقم الطلب:</strong> ${order.order_number}</p>
                            <p><strong>تاريخ الطلب:</strong> ${new Date(order.created_at).toLocaleDateString('ar-EG')}</p>
                            <p><strong>الإجمالي:</strong> ${order.total_amount} جنيه</p>
                            <p><strong>الحالة:</strong> ${order.status_text}</p>
                            <p><strong>طريقة الدفع:</strong> ${order.payment_method}</p>
                            <h4 style="margin-top: 1rem; color: #667eea;">تفاصيل المنتجات:</h4>
                            <ul style="list-style: none; padding-right: 1rem;">
                                ${order.items.map(item => `
                                    <li style="margin-bottom: 0.5rem;">
                                        - ${item.product ? item.product.name : 'منتج غير معروف'} (الكمية: ${item.quantity}, السعر: ${item.price} جنيه)
                                        ${item.selected_size ? ` | المقاس: ${item.selected_size}` : ''}
                                        ${item.selected_color ? ` | اللون: ${item.selected_color}` : ''}
                                        ${item.notes ? ` | ملاحظات: ${item.notes}` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('');
                } else {
                    userOrdersContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">لا توجد طلبات سابقة حتى الآن.</p>';
                }
            } catch (error) {
                console.error('خطأ في جلب طلبات المستخدم:', error);
                userOrdersContainer.innerHTML = '<p style="text-align: center; color: red; padding: 2rem;">فشل تحميل الطلبات. يرجى المحاولة لاحقاً.</p>';
            }
        }


        // تسجيل الدخول
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // استخدام fetchWithCredentials لتسجيل الدخول
                const response = await fetchWithCredentials(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = data.user;
                    showNotification(data.message, 'success');
                    updateAuthUI();
                    fetchCart();
                    showPage('home');
                } else {
                    showNotification(data.error || 'فشل تسجيل الدخول', 'error');
                }
            } catch (error) {
                console.error('خطأ في تسجيل الدخول:', error);
                showNotification('تعذر الاتصال بالخادم لتسجيل الدخول', 'error');
            }
        }

        // إنشاء حساب
        async function handleRegister(event) {
            event.preventDefault();
            const name = event.target.querySelector('#registerName').value;
            const email = event.target.querySelector('#registerEmail').value;
            const phone = event.target.querySelector('#registerPhone').value;
            const password = event.target.querySelector('#registerPassword').value;

            try {
                // استخدام fetchWithCredentials لإنشاء حساب
                const response = await fetchWithCredentials(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone, password })
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message + '. يمكنك الآن تسجيل الدخول.', 'success');
                    document.getElementById('registerForm').style.display = 'none'; // Hide register form
                    document.getElementById('loginForm').reset(); // Clear login form fields
                    document.getElementById('loginEmail').focus(); // Focus on email for login
                } else {
                    showNotification(data.error || 'فشل إنشاء الحساب', 'error');
                }
            } catch (error) {
                console.error('خطأ في إنشاء الحساب:', error);
                showNotification('تعذر الاتصال بالخادم لإنشاء الحساب', 'error');
            }
        }

        // عرض نموذج التسجيل
        function showRegister() {
            document.getElementById('registerForm').style.display = 'block';
        }

        // تسجيل الخروج
        async function logout() {
            try {
                // استخدام fetchWithCredentials لتسجيل الخروج
                const response = await fetchWithCredentials(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = null;
                    showNotification(data.message, 'success');
                    updateAuthUI();
                    updateCartCount(0); // Clear cart count on logout
                    showPage('home');
                } else {
                    showNotification(data.error || 'فشل تسجيل الخروج', 'error');
                }
            } catch (error) {
                console.error('خطأ في تسجيل الخروج:', error);
                showNotification('تعذر الاتصال بالخادم لتسجيل الخروج', 'error');
            }
        }

        // تحديث واجهة المصادقة
        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            
            if (currentUser) {
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                userName.textContent = `مرحباً، ${currentUser.name}`;
            } else {
                authButtons.style.display = 'flex'; /* تغيير من block إلى flex ليتناسب مع التصميم */
                userInfo.style.display = 'none';
            }
        }

        // إرسال رسالة الاتصال
        async function submitContactMessage(event) {
            event.preventDefault();
            const form = event.target;
            const name = form.querySelector('#contactName').value;
            const email = form.querySelector('#contactEmail').value;
            const phone = form.querySelector('#contactPhone').value;
            const subject = form.querySelector('#contactSubject').value;
            const message = form.querySelector('#contactMessage').value;

            try {
                // استخدام fetchWithCredentials لإرسال رسالة الاتصال
                const response = await fetchWithCredentials(`${API_BASE_URL}/contact`, {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone, subject, message })
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message, 'success');
                    form.reset();
                } else {
                    showNotification(data.error || 'فشل إرسال الرسالة', 'error');
                }
            } catch (error) {
                console.error('خطأ في إرسال رسالة الاتصال:', error);
                showNotification('تعذر الاتصال بالخادم لإرسال الرسالة', 'error');
            }
        }

        // تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async function() {
            // الأهم أن يتم هذا أولاً لتهيئة حالة المستخدم قبل جلب البيانات الأخرى
            await fetchCurrentUser(); 
            await fetchCategories(); 
            await fetchProducts();
            // fetchCart() يتم استدعاؤها داخل fetchCurrentUser() بعد تحديد حالة المستخدم
            showPage('home'); // Show home page by default
        });
    </script>
</body>
</html>